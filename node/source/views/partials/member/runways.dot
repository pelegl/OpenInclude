<ul id="runways" class="nav nav-tabs">
    {{? it.user.groups.indexOf("admin") >= 0 }}
    <li class="dropdown">
        <a href="/profile" class="dropdown-toggle" data-toggle="dropdown" data-target="#">Admin <b class="caret"></b></a>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#admin-connections" data-toggle="tab">Connections</a></li>
            <li><a href="#admin-finance" data-toggle="tab">Finance</a></li>
        </ul>
    </li>
    {{?}}
    {{? it.user.groups.indexOf("reader") >= 0 }}
    <li class="dropdown">
        <a href="/profile" class="dropdown-toggle" data-toggle="dropdown" data-target="#">Reader <b class="caret"></b></a>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#reader-runway" data-toggle="tab">Runway</a></li>
            <li><a href="#reader-finance" data-toggle="tab">Finance</a></li>
        </ul>
    </li>
    {{?}}
    {{? it.user.groups.indexOf("writer") >= 0 }}
    <li class="dropdown">
        <a href="/profile" class="dropdown-toggle" data-toggle="dropdown" data-target="#">Writer <b class="caret"></b></a>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#writer-runway" data-toggle="tab">Runway</a></li>
            <li><a href="#writer-finance" data-toggle="tab">Finance</a></li>
        </ul>
    </li>
    {{?}}
</ul>

<div class="tab-content">
    {{? it.user.groups.indexOf("admin") >= 0 }}
    <div class="tab-pane" id="admin-connections">
        <table class="table table-bordered table-hover" style="background-color: #ffffff">
            <tr>
                <th>Reader</th>
                <th>Hourly charged</th>
                <th>Writer</th>
                <th>Hourly paid</th>
            </tr>
            {{~ it.connections :connection }}
            <tr>
                <td><a href="/profile/view/{{= connection.reader.name }}">{{= connection.reader.name }}</a></td>
                <td>{{= connection.charged + connection.charged * connection.fee / 100 }}</td>
                <td><a href="/profile/view/{{= connection.writer.name }}">{{= connection.writer.name }}</a></td>
                <td>{{= connection.charged }}</td>
            </tr>
            {{~}}
        </table>
        <div>
            <div style="margin-bottom: 20px"><a href="#" id="new-connection" class="btn btn-small btn-success">New connection</a></div>
            <div id="new-connection-inline"></div>
        </div>
    </div>
    <div class="tab-pane" id="admin-finance">
        TODO
    </div>
    {{?}}
    {{? it.user.groups.indexOf("reader") >= 0 }}
    <div class="tab-pane" id="reader-runway">
        <table class="table table-bordered table-hover" style="background-color: #ffffff">
            <tr>
                <th>Writer</th>
                <th>Hourly rate</th>
                <th>Runway</th>
                <th>Actions</th>
            </tr>
            {{~ it.runways_reader :runway }}
            {{
                worked = 0;
                for (r in runway.runways)
                {
                    worked += parseInt(runway.runways[r].worked);
                }
            }}

            <tr>
                <td><a href="/profile/view/{{= runway.writer.name }}">{{= runway.writer.name }}</a></td>
                <td>{{= runway.charged + runway.charged * runway.fee / 100 }}</td>
                <td>{{= worked }} / {{= runway.data }}</td>
                <td>
                    <button id="alter-runway" rel="{{= runway._id }}" data-limit="{{= worked }}" data-current="{{= runway.data }}" class="btn btn-small btn-success">Alter</button>
                    <div id="alter-runway-inline-{{= runway._id }}" style="margin-top: 15px; display: none"></div>
                </td>
            </tr>
            {{~}}
        </table>
    </div>
    <div class="tab-pane" id="reader-finance">
        <table class="table table-bordered table-hover" style="background-color: #ffffff">
            <tr>
                <th>Date</th>
                <th></th>
                <th>Amount</th>
            </tr>
        {{ _.each(it.finance_reader, function(writer, date) { amount = 0; }}
            <tr>
                <td>{{= date }}</td>
                <td>
                    <button class="btn btn-info btn-small" data-toggle="collapse" data-target="#data-{{= date }}">Show details</button>
                    <div id="data-{{= date }}" class="collapse finance">
                        {{ _.each(writer, function(finances, name) { }}
                        {{= name }} â†’
                        <ul class="finance-list">
                            {{ _.each(finances, function(finance) { }}
                                {{ bill = finance.worked * (finance.charged + finance.charged * finance.fee / 100); amount += bill; }}
                                <li>{{= finance.memo }} = ${{= bill }}</li>
                            {{ }); }}
                        </ul>
                        {{ }); }}
                    </div>
                </td>
                <td>${{= amount }}</td>
            </tr>
        {{ }); }}
        </table>
    </div>
    {{?}}
    {{? it.user.groups.indexOf("writer") >= 0 }}
    <div class="tab-pane" id="writer-runway">
        <table class="table table-bordered table-hover" style="background-color: #ffffff">
            <tr>
                <th>Reader</th>
                <th>Hourly rate</th>
                <th>Runway</th>
                <th>Actions</th>
            </tr>
            {{~ it.runways_writer :runway }}
            {{
                worked = 0;
                for (r in runway.runways)
                {
                    worked += parseInt(runway.runways[r].worked);
                }
            }}
            <tr>
                <td><a href="/profile/view/{{= runway.reader.name }}">{{= runway.reader.name }}</a></td>
                <td>{{= runway.charged }}</td>
                <td>{{= worked }} / {{= runway.data }}</td>
                <td>
                    {{? worked >= runway.data }}
                    Allowed time limit exceeded.
                    {{??}}
                    <button id="track-time" rel="{{= runway._id }}" data-limit="{{= runway.data - worked }}" class="btn btn-small btn-success">Track</button>
                    {{?}}
                    <div id="track-time-inline-{{= runway._id }}" style="margin-top: 15px; display: none"></div>
                </td>
            </tr>
            {{~}}
        </table>
    </div>
    <div class="tab-pane{{? it.active_tab == 'writer-finance'}} active{{?}}" id="writer-finance">
        <div class="runway-date">
            <div class="daterange pull-left">
                <i class="icon-calendar icon-large"></i>
                <span id="writer_filter" class="value">{{= it.writer_filter || "All time" }}</span>
                <b class="caret"></b>
                <span id="writer_from" class="from" style="display: none"></span>
                <span id="writer_to" class="to" style="display: none"></span>
            </div>
            <button id="writer-filter" class="btn btn-info">View</button>
        </div>
        <table class="table table-bordered table-hover" style="background-color: #ffffff">
            <tr>
                <th>Client</th>
                <th>Paid</th>
                <th>Pending</th>
            </tr>
            {{~ it.runways_writer :finance }}
            {{
                paid = 0;
                pending = 0;
                for (r in finance.runways)
                {
                    data = finance.runways[r];
                    m = moment(data.date);
                    f = moment(it.from);
                    t = moment(it.to);
                    if (it.from != "none" && it.to != "none" && !((m.isAfter(f, 'day') || m.isSame(f, 'day')) && (m.isBefore(t, 'day')) || m.isSame(t, 'day'))) continue;
                    if (data.paid) paid += data.charged; else pending += data.charged;
                }
            }}

            <tr>
                <td><a href="/profile/view/{{= finance.writer.name }}">{{= finance.writer.name }}</a></td>
                <td>{{= paid }}</td>
                <td>{{= pending }}</td>
            </tr>
            {{~}}
        </table>
    </div>
    {{?}}
</div>
<script type="text/javascript">
    $(document).ready(function() {
        $('.daterange').daterangepicker(
            {
                ranges: {
                    'All time': ['today', 'today'],
                    'This week': ['last monday', 'today'],
                    'Last week': [Date.parse('last monday').addWeeks(-1), 'last sunday'],
                    'Last month': [Date.parse('last month').addDays(-Date.parse('last month').getDate() + 1), Date.parse('today').addDays(-Date.parse('today').getDate())]
                }
            },
            function(start, end) {
                if (start.toString('yyyy-MM-dd') == end.toString('yyyy-MM-dd'))
                {
                    $('.daterange .value').html("All time");
                    $('.daterange .from').html("none");
                    $('.daterange .to').html("none");
                }
                else
                {
                    $('.daterange .value').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));
                    $('.daterange .from').html(start.toString('yyyy-MM-dd'));
                    $('.daterange .to').html(end.toString('yyyy-MM-dd'));
                }
            }
        );
    });
</script>