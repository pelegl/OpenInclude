###
  Config
###
nodeio           = require 'node.io'
qs               = require 'querystring'
agents           = require 'user-agents' 
###
  Hideme config
###
Host = "http://www.hidemyass.com/proxy-list/"

###
  Scraping class
###
proxies = []
{jsdom}   = require "jsdom"


class HideMeProxyScraper extends nodeio.JobClass
  input: false
  
  run: ->
    headers = 
      "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      "user-agent": agents.random()
      "accept-language": "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"
      "cache-control"  : "max-age=0"
      "connection"     : "keep-alive"
      "accept-charset" : "utf-8,windows-1251;q=0.7,*;q=0.3"
    
    ###
      HTTPS proxies
    ###
    #body = "ac=on&c%5B%5D=China&c%5B%5D=Kazakhstan&c%5B%5D=Indonesia&c%5B%5D=Brazil&c%5B%5D=Venezuela&c%5B%5D=United+States&c%5B%5D=Russian+Federation&c%5B%5D=Colombia&c%5B%5D=India&c%5B%5D=Iran&c%5B%5D=Thailand&c%5B%5D=Poland&c%5B%5D=Ecuador&c%5B%5D=Chile&c%5B%5D=Ukraine&c%5B%5D=Hong+Kong&c%5B%5D=Korea%2C+Republic+of&c%5B%5D=Egypt&c%5B%5D=Bangladesh&c%5B%5D=Cambodia&c%5B%5D=Iraq&c%5B%5D=Nigeria&c%5B%5D=Honduras&c%5B%5D=Kenya&c%5B%5D=Luxembourg&c%5B%5D=Peru&c%5B%5D=Czech+Republic&c%5B%5D=Moldova%2C+Republic+of&c%5B%5D=Malaysia&c%5B%5D=Germany&c%5B%5D=Latvia&c%5B%5D=Bulgaria&c%5B%5D=Argentina&c%5B%5D=Pakistan&c%5B%5D=United+Kingdom&c%5B%5D=Hungary&c%5B%5D=France&c%5B%5D=Taiwan&c%5B%5D=Netherlands&c%5B%5D=Taiwan&c%5B%5D=Philippines&c%5B%5D=Ghana&c%5B%5D=Turkey&c%5B%5D=Mexico&c%5B%5D=Slovakia&c%5B%5D=Serbia&c%5B%5D=Afghanistan&c%5B%5D=Canada&c%5B%5D=Croatia&c%5B%5D=Viet+Nam&c%5B%5D=United+Arab+Emirates&c%5B%5D=Saudi+Arabia&c%5B%5D=Mongolia&c%5B%5D=Tanzania%2C+United+Republic+of&c%5B%5D=Sweden&c%5B%5D=Spain&c%5B%5D=Australia&c%5B%5D=Bosnia+and+Herzegovina&c%5B%5D=Romania&c%5B%5D=Libyan+Arab+Jamahiriya&c%5B%5D=Lebanon&c%5B%5D=Azerbaijan&c%5B%5D=Nepal&c%5B%5D=Namibia&c%5B%5D=Japan&c%5B%5D=Netherlands+Antilles&c%5B%5D=Macedonia&c%5B%5D=Bolivia&c%5B%5D=Uzbekistan&c%5B%5D=Zaire&c%5B%5D=Costa+Rica&c%5B%5D=Cote+D%27Ivoire&c%5B%5D=Zambia&c%5B%5D=Morocco&c%5B%5D=Cameroon&c%5B%5D=Paraguay&c%5B%5D=Trinidad+and+Tobago&c%5B%5D=Italy&c%5B%5D=Slovenia&c%5B%5D=Lithuania&c%5B%5D=South+Africa&c%5B%5D=Ireland&c%5B%5D=Denmark&c%5B%5D=Zimbabwe&c%5B%5D=Brunei+Darussalam&c%5B%5D=Georgia&c%5B%5D=Armenia&c%5B%5D=Israel&p=&pr%5B%5D=1&a%5B%5D=3&a%5B%5D=4&pl=on&sp%5B%5D=3&ct%5B%5D=3&s=0&o=0&pp=2&sortBy=date"
    ###
      HTTP proxies
    ### 
    body = "ac=on&c%5B%5D=China&c%5B%5D=Kazakhstan&c%5B%5D=Brazil&c%5B%5D=Indonesia&c%5B%5D=Russian+Federation&c%5B%5D=United+States&c%5B%5D=Venezuela&c%5B%5D=Colombia&c%5B%5D=Iran&c%5B%5D=India&c%5B%5D=Thailand&c%5B%5D=Korea%2C+Republic+of&c%5B%5D=Chile&c%5B%5D=Ecuador&c%5B%5D=Poland&c%5B%5D=Cambodia&c%5B%5D=Iraq&c%5B%5D=Ukraine&c%5B%5D=Egypt&c%5B%5D=Honduras&c%5B%5D=Nigeria&c%5B%5D=Kenya&c%5B%5D=Bangladesh&c%5B%5D=Argentina&c%5B%5D=France&c%5B%5D=Hong+Kong&c%5B%5D=Pakistan&c%5B%5D=Germany&c%5B%5D=Malaysia&c%5B%5D=Saudi+Arabia&c%5B%5D=Czech+Republic&c%5B%5D=Bulgaria&c%5B%5D=Turkey&c%5B%5D=Philippines&c%5B%5D=Moldova%2C+Republic+of&c%5B%5D=Romania&c%5B%5D=Peru&c%5B%5D=Canada&c%5B%5D=Hungary&c%5B%5D=Serbia&c%5B%5D=Netherlands&c%5B%5D=Taiwan&c%5B%5D=Ghana&c%5B%5D=Viet+Nam&c%5B%5D=Slovakia&c%5B%5D=Taiwan&c%5B%5D=Denmark&c%5B%5D=Mongolia&c%5B%5D=Latvia&c%5B%5D=Bosnia+and+Herzegovina&c%5B%5D=Nepal&c%5B%5D=United+Arab+Emirates&c%5B%5D=Luxembourg&c%5B%5D=Tanzania%2C+United+Republic+of&c%5B%5D=Macedonia&c%5B%5D=Mexico&c%5B%5D=Bolivia&c%5B%5D=Albania&c%5B%5D=Japan&c%5B%5D=Lebanon&c%5B%5D=Australia&c%5B%5D=United+Kingdom&c%5B%5D=Spain&c%5B%5D=Croatia&c%5B%5D=Namibia&c%5B%5D=Italy&c%5B%5D=Uzbekistan&c%5B%5D=Netherlands+Antilles&c%5B%5D=Azerbaijan&c%5B%5D=Zimbabwe&c%5B%5D=Sweden&c%5B%5D=Lithuania&c%5B%5D=Paraguay&c%5B%5D=Zaire&c%5B%5D=Libyan+Arab+Jamahiriya&c%5B%5D=Zambia&c%5B%5D=Palestinian+Territory%2C+Occupied&c%5B%5D=Israel&c%5B%5D=Cote+D%27Ivoire&c%5B%5D=Singapore&c%5B%5D=Cameroon&c%5B%5D=Afghanistan&c%5B%5D=Georgia&c%5B%5D=South+Africa&c%5B%5D=Ireland&c%5B%5D=Morocco&p=&pr%5B%5D=0&a%5B%5D=2&a%5B%5D=3&sp%5B%5D=3&ct%5B%5D=3&s=0&o=0&pp=2&sortBy=date"
      
    @postHtml Host, body, headers, (err, $, data)=>
      @exit err if @err
      
      #console.log data
      data = data.replace /<div id="fb-root"[\w\W]*<\/script>/im, ""
      
      #@emit data
            
      document = jsdom data
      window = document.createWindow()

      #@emit window.document.innerHTML
      
      require("jsdom").jQueryify window, "http://code.jquery.com/jquery.js", =>
        $ = window.$        
        tr = $("#listtable thead").nextAll("tr")
        hosts = []
        $.each tr, (index, proxy)=>
          proxy = $(proxy).children("td")
          child = proxy.eq(1).children("span")                             
          host_container = child.children()                                        
          $.each host_container, (i, val)=>
            host = $(val)
            if ! host.is(":visible") or host.is(":empty")
              host.remove() 
          
          child.children("style").remove()
          child.children().removeAttr("class style")
          
          ip = proxy.eq(1).children("span").html().replace /[^\.0-9]/ig, ""
                      
          hosts.push {
            ip
            port: parseInt(proxy.eq(2).text())
          }
            
        @emit hosts      
         
        
@class = HideMeProxyScraper
@job   = new HideMeProxyScraper {timeout: 10, encoding: "utf8", auto_retry: true}