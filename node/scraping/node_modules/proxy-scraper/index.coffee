###
  Config
###
nodeio           = require 'node.io'
qs               = require 'querystring'
###
  Hideme config
###

Host = "http://www.hidemyass.com/proxy-list/"

###
  User Agents
###

Agents = [
  "Mozilla/5.0 (Macintosh; U; PPC Mac OS X; fi-fi) AppleWebKit/420+ (KHTML, like Gecko) Safari/419.3"
  "Mozilla/5.0 (Macintosh; U; PPC Mac OS X; de-de) AppleWebKit/125.2 (KHTML, like Gecko) Safari/125.7"
  "Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en-us) AppleWebKit/312.8 (KHTML, like Gecko) Safari/312.6"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; cs-CZ) AppleWebKit/523.15 (KHTML, like Gecko) Version/3.0 Safari/523.15"
  "Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) AppleWebKit/528.16 (KHTML, like Gecko) Version/4.0 Safari/528.16"
  "Mozilla/5.0 (Macintosh; U; PPC Mac OS X 10_5_6; it-it) AppleWebKit/528.16 (KHTML, like Gecko) Version/4.0 Safari/528.16"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-HK) AppleWebKit/533.18.1 (KHTML, like Gecko) Version/5.0.2 Safari/533.18.5"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; sv-SE) AppleWebKit/533.19.4 (KHTML, like Gecko) Version/5.0.3 Safari/533.19.4"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4 Safari/533.20.27"
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/534.55.3 (KHTML, like Gecko) Version/5.1.3 Safari/534.53.10"
  "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3) Gecko/20090305 Firefox/3.1b3 GTB5"
  "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; ko; rv:1.9.1b2) Gecko/20081201 Firefox/3.1b2"
  "Mozilla/5.0 (X11; U; SunOS sun4u; en-US; rv:1.9b5) Gecko/2008032620 Firefox/3.0b5"
  "Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.8.1.12) Gecko/20080214 Firefox/2.0.0.12"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; cs; rv:1.9.0.8) Gecko/2009032609 Firefox/3.0.8"
  "Mozilla/5.0 (X11; U; OpenBSD i386; en-US; rv:1.8.0.5) Gecko/20060819 Firefox/1.5.0.5"
  "Mozilla/5.0 (Windows; U; Windows NT 5.0; es-ES; rv:1.8.0.3) Gecko/20060426 Firefox/1.5.0.3"
  "Mozilla/5.0 (Windows; U; WinNT4.0; en-US; rv:1.7.9) Gecko/20050711 Firefox/1.0.5"
  "Mozilla/5.0 (Windows; Windows NT 6.1; rv:2.0b2) Gecko/20100720 Firefox/4.0b2"
  "Mozilla/5.0 (X11; Linux x86_64; rv:2.0b4) Gecko/20100818 Firefox/4.0b4"
  "Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.2) Gecko/20100308 Ubuntu/10.04 (lucid) Firefox/3.6 GTB7.1"
  "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b7) Gecko/20101111 Firefox/4.0b7"
  "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b8pre) Gecko/20101114 Firefox/4.0b8pre"
  "Mozilla/5.0 (X11; Linux x86_64; rv:2.0b9pre) Gecko/20110111 Firefox/4.0b9pre"
  "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0b9pre) Gecko/20101228 Firefox/4.0b9pre"
  "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.2a1pre) Gecko/20110324 Firefox/4.2a1pre"
  "Mozilla/5.0 (X11; U; Linux amd64; rv:5.0) Gecko/20100101 Firefox/5.0 (Debian)"
  "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0a2) Gecko/20110613 Firefox/6.0a2"
  "Mozilla/5.0 (X11; Linux i686 on x86_64; rv:12.0) Gecko/20100101 Firefox/12.0"
  "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/525.19 (KHTML, like Gecko) Chrome/1.0.154.53 Safari/525.19"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/525.19 (KHTML, like Gecko) Chrome/1.0.154.36 Safari/525.19"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.10 (KHTML, like Gecko) Chrome/7.0.540.0 Safari/534.10"
  "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/534.4 (KHTML, like Gecko) Chrome/6.0.481.0 Safari/534.4"
  "Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US) AppleWebKit/533.4 (KHTML, like Gecko) Chrome/5.0.375.86 Safari/533.4"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/532.2 (KHTML, like Gecko) Chrome/4.0.223.3 Safari/532.2"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.0 (KHTML, like Gecko) Chrome/4.0.201.1 Safari/532.0"
  "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/532.0 (KHTML, like Gecko) Chrome/3.0.195.27 Safari/532.0"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/530.5 (KHTML, like Gecko) Chrome/2.0.173.1 Safari/530.5"
  "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/534.10 (KHTML, like Gecko) Chrome/8.0.558.0 Safari/534.10"
  "Mozilla/5.0 (X11; U; Linux x86_64; en-US) AppleWebKit/540.0 (KHTML,like Gecko) Chrome/9.1.0.0 Safari/540.0"
  "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/534.14 (KHTML, like Gecko) Chrome/9.0.600.0 Safari/534.14"
  "Mozilla/5.0 (X11; U; Windows NT 6; en-US) AppleWebKit/534.12 (KHTML, like Gecko) Chrome/9.0.587.0 Safari/534.12"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.13 (KHTML, like Gecko) Chrome/9.0.597.0 Safari/534.13"
  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.16 (KHTML, like Gecko) Chrome/10.0.648.11 Safari/534.16"
  "Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) AppleWebKit/534.20 (KHTML, like Gecko) Chrome/11.0.672.2 Safari/534.20"
  "Mozilla/5.0 (Windows NT 6.0) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.792.0 Safari/535.1"
  "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.872.0 Safari/535.2"
  "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.7 (KHTML, like Gecko) Chrome/16.0.912.36 Safari/535.7"
  "Mozilla/5.0 (Windows NT 6.0; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.66 Safari/535.11"
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/535.19 (KHTML, like Gecko) Chrome/18.0.1025.45 Safari/535.19"
  "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/535.24 (KHTML, like Gecko) Chrome/19.0.1055.1 Safari/535.24"
  "Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6"
  "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1"
  "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.15 (KHTML, like Gecko) Chrome/24.0.1295.0 Safari/537.15"
]


###
  Scraping class
###
proxies = []
{jsdom}   = require "jsdom"

#require("jsdom").defaultDocumentFeatures = {
#  FetchExternalResources: ["css"],
##  ProcessExternalResources: true
#}



class HideMeProxyScraper extends nodeio.JobClass
  input: false
  run: ->
    headers = 
      "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      "user-agent": Agents[Math.floor(Math.random()*Agents.length)]
      "accept-language": "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"
      "cache-control"  : "max-age=0"
      "connection"     : "keep-alive"
      "accept-charset" : "utf-8,windows-1251;q=0.7,*;q=0.3"
    
    body = "ac=on&c%5B%5D=China&c%5B%5D=Kazakhstan&c%5B%5D=Indonesia&c%5B%5D=Brazil&c%5B%5D=Venezuela&c%5B%5D=United+States&c%5B%5D=Russian+Federation&c%5B%5D=Colombia&c%5B%5D=India&c%5B%5D=Iran&c%5B%5D=Thailand&c%5B%5D=Poland&c%5B%5D=Ecuador&c%5B%5D=Chile&c%5B%5D=Ukraine&c%5B%5D=Hong+Kong&c%5B%5D=Korea%2C+Republic+of&c%5B%5D=Egypt&c%5B%5D=Bangladesh&c%5B%5D=Cambodia&c%5B%5D=Iraq&c%5B%5D=Nigeria&c%5B%5D=Honduras&c%5B%5D=Kenya&c%5B%5D=Luxembourg&c%5B%5D=Peru&c%5B%5D=Czech+Republic&c%5B%5D=Moldova%2C+Republic+of&c%5B%5D=Malaysia&c%5B%5D=Germany&c%5B%5D=Latvia&c%5B%5D=Bulgaria&c%5B%5D=Argentina&c%5B%5D=Pakistan&c%5B%5D=United+Kingdom&c%5B%5D=Hungary&c%5B%5D=France&c%5B%5D=Taiwan&c%5B%5D=Netherlands&c%5B%5D=Taiwan&c%5B%5D=Philippines&c%5B%5D=Ghana&c%5B%5D=Turkey&c%5B%5D=Mexico&c%5B%5D=Slovakia&c%5B%5D=Serbia&c%5B%5D=Afghanistan&c%5B%5D=Canada&c%5B%5D=Croatia&c%5B%5D=Viet+Nam&c%5B%5D=United+Arab+Emirates&c%5B%5D=Saudi+Arabia&c%5B%5D=Mongolia&c%5B%5D=Tanzania%2C+United+Republic+of&c%5B%5D=Sweden&c%5B%5D=Spain&c%5B%5D=Australia&c%5B%5D=Bosnia+and+Herzegovina&c%5B%5D=Romania&c%5B%5D=Libyan+Arab+Jamahiriya&c%5B%5D=Lebanon&c%5B%5D=Azerbaijan&c%5B%5D=Nepal&c%5B%5D=Namibia&c%5B%5D=Japan&c%5B%5D=Netherlands+Antilles&c%5B%5D=Macedonia&c%5B%5D=Bolivia&c%5B%5D=Uzbekistan&c%5B%5D=Zaire&c%5B%5D=Costa+Rica&c%5B%5D=Cote+D%27Ivoire&c%5B%5D=Zambia&c%5B%5D=Morocco&c%5B%5D=Cameroon&c%5B%5D=Paraguay&c%5B%5D=Trinidad+and+Tobago&c%5B%5D=Italy&c%5B%5D=Slovenia&c%5B%5D=Lithuania&c%5B%5D=South+Africa&c%5B%5D=Ireland&c%5B%5D=Denmark&c%5B%5D=Zimbabwe&c%5B%5D=Brunei+Darussalam&c%5B%5D=Georgia&c%5B%5D=Armenia&c%5B%5D=Israel&p=&pr%5B%5D=1&a%5B%5D=3&a%5B%5D=4&pl=on&sp%5B%5D=3&ct%5B%5D=3&s=0&o=0&pp=2&sortBy=date"
      
    @postHtml Host, body, headers, (err, $, data)=>
      @exit err if @err
      
      #console.log data
      data = data.replace /<div id="fb-root"[\w\W]*<\/script>/im, ""
      
      #@emit data
            
      document = jsdom data
      window = document.createWindow()

      #@emit window.document.innerHTML
      
      require("jsdom").jQueryify window, "http://code.jquery.com/jquery.js", =>
        $ = window.$        
        tr = $("#listtable thead").nextAll("tr")
        hosts = []
        $.each tr, (index, proxy)=>
          proxy = $(proxy).children("td")
          child = proxy.eq(1).children("span")                             
          host_container = child.children()                                        
          $.each host_container, (i, val)=>
            host = $(val)
            if ! host.is(":visible") or host.is(":empty")
              host.remove() 
          
          child.children("style").remove()
          child.children().removeAttr("class style")
          
          ip = proxy.eq(1).children("span").html().replace /[^\.0-9]/ig, ""
                      
          hosts.push {
            ip
            port: parseInt(proxy.eq(2).text())
          }
            
        @emit JSON.stringify hosts      
        
      
  
@class = HideMeProxyScraper
@job   = new HideMeProxyScraper {timeout: 20, encoding: "utf8" }